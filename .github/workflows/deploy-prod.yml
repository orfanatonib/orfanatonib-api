name: Deploy Production Orfanato API

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_STACK_NAME: orfanato-nib-ecr
  EC2_STACK_NAME: orfanato-nib-ec2
  ENVIRONMENT: production

jobs:
  build-and-deploy:
    name: Build, Push and Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ›  Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: âœ… Run tests
        run: npm test

      - name: ğŸ— Build project
        run: npm run build

      - name: ğŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ” Get ECR repository URI
        id: ecr-info
        run: |
          REPOSITORY_URI=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.ECR_STACK_NAME }} \
            --query 'Stacks[0].Outputs[?OutputKey==`ProductionRepositoryUri`].OutputValue' \
            --output text)
          echo "repository_uri=$REPOSITORY_URI" >> $GITHUB_OUTPUT
          echo "âœ… ECR Repository: $REPOSITORY_URI"

      - name: ğŸ” Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: ğŸ³ Build Docker image
        env:
          ECR_REPOSITORY: ${{ steps.ecr-info.outputs.repository_uri }}
          IMAGE_TAG: latest
        run: |
          echo "ğŸ”¨ Building image: ${ECR_REPOSITORY}:${IMAGE_TAG}"
          docker build -f DockerFile -t ${ECR_REPOSITORY}:${IMAGE_TAG} .
          docker tag ${ECR_REPOSITORY}:${IMAGE_TAG} ${ECR_REPOSITORY}:${{ github.sha }}

      - name: ğŸ“¤ Push image to ECR
        env:
          ECR_REPOSITORY: ${{ steps.ecr-info.outputs.repository_uri }}
          IMAGE_TAG: latest
        run: |
          echo "ğŸ“¤ Pushing image: ${ECR_REPOSITORY}:${IMAGE_TAG}"
          docker push ${ECR_REPOSITORY}:${IMAGE_TAG}
          docker push ${ECR_REPOSITORY}:${{ github.sha }}
          echo "âœ… Images pushed successfully!"

      - name: ğŸ” Get EC2 instance info
        id: ec2-info
        run: |
          INSTANCE_ID=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.EC2_STACK_NAME }} \
            --query 'Stacks[0].Outputs[?OutputKey==`InstanceIdProd`].OutputValue' \
            --output text)
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "âœ… Instance ID: $INSTANCE_ID"

      - name: ğŸ“ Create .env file for deployment
        run: |
          cat > /tmp/prod.env << 'EOF'
          ENVIRONMENT=${{ secrets.PROD_ENVIRONMENT }}
          PORT=${{ secrets.PORT }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=${{ secrets.PROD_DB_NAME }}
          AWS_REGION=${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_S3_BUCKET_NAME=${{ secrets.AWS_S3_BUCKET_NAME }}
          SES_DEFAULT_FROM=${{ secrets.PROD_SES_DEFAULT_FROM }}
          SES_DEFAULT_TO=${{ secrets.PROD_SES_DEFAULT_TO }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRES_IN=${{ secrets.JWT_EXPIRES_IN }}
          JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
          JWT_REFRESH_EXPIRES_IN=${{ secrets.JWT_REFRESH_EXPIRES_IN }}
          TWILIO_ACCOUNT_SID=${{ secrets.PROD_TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN=${{ secrets.PROD_TWILIO_AUTH_TOKEN }}
          TWILIO_WHATSAPP_FROM=${{ secrets.PROD_TWILIO_WHATSAPP_FROM }}
          TWILIO_WHATSAPP_TO=${{ secrets.PROD_TWILIO_WHATSAPP_TO }}
          FEED_ORFANATO_PAGE_ID=${{ secrets.PROD_FEED_ORFANATO_PAGE_ID }}
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          EOF

      - name: ğŸš€ Deploy to EC2 via SSM
        env:
          INSTANCE_ID: ${{ steps.ec2-info.outputs.instance_id }}
          ECR_REPOSITORY: ${{ steps.ecr-info.outputs.repository_uri }}
          IMAGE_TAG: latest
        run: |
          echo "ğŸš€ Deploying to EC2 instance: $INSTANCE_ID"

          # Encode .env file to base64
          ENV_B64=$(base64 -w0 /tmp/prod.env)

          # Send deployment command via SSM
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters "commands=[
              'set -e',
              'echo \"ğŸ” Logging into ECR...\"',
              'aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${ECR_REPOSITORY}',
              'echo \"ğŸ“ Creating env directory...\"',
              'mkdir -p /opt/orfanato-nib-api/env',
              'echo \"ğŸ“ Writing .env file...\"',
              'echo ${ENV_B64} | base64 -d > /opt/orfanato-nib-api/env/prod.env',
              'echo \"ğŸ›‘ Stopping old container...\"',
              'docker stop orfanato-nib-api || true',
              'docker rm orfanato-nib-api || true',
              'echo \"ğŸ“¥ Pulling new image...\"',
              'docker pull ${ECR_REPOSITORY}:${IMAGE_TAG}',
              'echo \"ğŸƒ Starting new container...\"',
              'docker run -d --name orfanato-nib-api --restart unless-stopped -p 80:3000 -p 3000:3000 --env-file /opt/orfanato-nib-api/env/prod.env ${ECR_REPOSITORY}:${IMAGE_TAG}',
              'sleep 3',
              'echo \"âœ… Container started:\"',
              'docker ps | grep orfanato-nib-api',
              'echo \"ğŸ§¹ Cleaning up old Docker images...\"',
              'docker image prune -af --filter \"until=24h\" || true',
              'echo \"âœ… Cleanup completed\"'
            ]" \
            --output text --query 'Command.CommandId')

          echo "Command ID: $COMMAND_ID"

          # Wait for command completion
          echo "â³ Waiting for deployment to complete..."
          MAX_ATTEMPTS=30
          ATTEMPT=0
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$INSTANCE_ID" \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")

            if [ "$STATUS" = "Success" ] || [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
              break
            fi

            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - Status: $STATUS"
            sleep 5
          done

          # Get command result
          STATUS=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query 'Status' \
            --output text)

          STDOUT=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query 'StandardOutputContent' \
            --output text)

          STDERR=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query 'StandardErrorContent' \
            --output text)

          echo "ğŸ“‹ Deployment Status: $STATUS"
          echo ""
          echo "ğŸ“¤ Standard Output:"
          echo "$STDOUT"

          if [ -n "$STDERR" ] && [ "$STDERR" != "None" ]; then
            echo ""
            echo "âš ï¸ Standard Error:"
            echo "$STDERR"
          fi

          if [ "$STATUS" != "Success" ]; then
            echo "âŒ Deployment failed!"
            exit 1
          fi

          echo "âœ… Deployment completed successfully!"

      - name: ğŸ‰ Deployment Summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘        âœ… Production Deployment Complete!             â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“‹ Summary:"
          echo "   Environment: production"
          echo "   Image: ${{ steps.ecr-info.outputs.repository_uri }}:latest"
          echo "   Commit: ${{ github.sha }}"
          echo ""
          echo "ğŸŒ API URL: https://api.orfanatonib.com"
          echo ""
          echo "ğŸ’¡ Test the API:"
          echo "   curl https://api.orfanatonib.com/health"
